<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mentorium ‚Äî –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <!-- Supabase JS -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <!-- Google API -->
  <script src="https://apis.google.com/js/api.js"></script>
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Jitsi -->
  <script src="https://meet.jit.si/external_api.js"></script>

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:sans-serif; background:#121212; color:#fff; }
    header { background:#1f1f1f; padding:1rem; text-align:center; position:sticky; top:0; z-index:5; }
    #welcome { font-size:1.2rem; }
    main { padding:1rem; padding-bottom:4rem; }
    .tab { display:none; }
    .tab.active { display:block; }
    .card { background:#1e1e1e; border-radius:8px; padding:1rem; margin-bottom:1rem; }
    .card-title { font-weight:bold; margin-bottom:.5rem; }
    nav.tab-bar {
      position:fixed; bottom:0; left:0; right:0; height:3.5rem;
      display:flex; background:#1f1f1f; border-top:1px solid #333;
    }
    nav.tab-bar button {
      flex:1; border:none; background:none; color:#aaa;
      font-size:.8rem; padding:.5rem 0;
    }
    nav.tab-bar button.active { color:#fff; }
    #calendar { background:#fff; color:#000; border-radius:8px; overflow:hidden; min-height:300px; }
    .fc-daygrid-day-frame { cursor:pointer; }
    #events-on-day .card-title { font-size:1rem; }
    #event-list { list-style:none; margin-top:.5rem; }
    #event-list li { padding:.5rem 0; border-bottom:1px solid #333; font-size:.9rem; }
    input, button { font-size:1rem; }
    button.upload { background:#4caf50; color:#fff; border:none; padding:.5rem 1rem; border-radius:4px; cursor:pointer; }
    #authorize-btn { background:#4285f4; color:#fff; border:none; padding:.5rem 1rem; border-radius:4px; cursor:pointer; }
  </style>
</head>

<body>
  <header>
    <div id="welcome">–ü—Ä–∏–≤–µ—Ç, <span id="student-name">–°—Ç—É–¥–µ–Ω—Ç</span></div>
  </header>

  <main>
    <!-- –í–∫–ª–∞–¥–∫–∞: –ë–ª–∏–∂–∞–π—à–µ–µ —Å–æ–±—ã—Ç–∏–µ -->
    <section id="tab-next" class="tab active">
      <div class="card">
        <div class="card-title">üöÄ –ë–ª–∏–∂–∞–π—à–µ–µ –∑–∞–Ω—è—Ç–∏–µ</div>
        <div id="next-event-content">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å</div>
        <button id="authorize-btn">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Google</button>
      </div>
    </section>

    <!-- –í–∫–ª–∞–¥–∫–∞: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
    <section id="tab-schedule" class="tab">
      <div class="card">
        <div class="card-title">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
        <div id="calendar"></div>
        <div id="events-on-day" class="card">
          <div class="card-title">–ó–∞–Ω—è—Ç–∏—è –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</div>
          <ul id="event-list"><li>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</li></ul>
        </div>
      </div>
    </section>

    <!-- –í–∫–ª–∞–¥–∫–∞: –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è -->
    <section id="tab-homework" class="tab">
      <div class="card">
        <div class="card-title">üìù –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>
        <input type="file" id="hw-file">
        <button class="upload" onclick="uploadHomework()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –î–ó</button>
        <div id="hw-status" style="margin-top:.5rem;"></div>
        <h3 style="margin-top:1rem;">–ú–æ–∏ —Ñ–∞–π–ª—ã</h3>
        <div id="hw-list">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </section>

    <!-- –í–∫–ª–∞–¥–∫–∞: –í–∏–¥–µ–æ–º–∞—Ç–µ—Ä–∏–∞–ª—ã -->
    <section id="tab-video" class="tab">
      <div class="card">
        <div class="card-title">üé• –í–∏–¥–µ–æ–º–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
        <input type="file" id="video-file" accept="video/*"><br><br>
        <input type="text" id="video-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ">
        <button class="upload" onclick="uploadVideo()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
        <div id="video-status" style="margin-top:.5rem;"></div>
        <h3 style="margin-top:1rem;">–°–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ</h3>
        <div id="video-list">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </section>

    <!-- –í–∫–ª–∞–¥–∫–∞: Jitsi -->
    <section id="tab-jitsi" class="tab">
      <div class="card">
        <div class="card-title">ü¶ö –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ Jitsi</div>
        <div id="jitsi-container" style="height:300px;"></div>
        <div style="margin-top:1rem;display:flex;gap:.5rem;flex-wrap:wrap;">
          <button onclick="jitsiApi.executeCommand('toggleAudio')">üéô –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
          <button onclick="jitsiApi.executeCommand('toggleVideo')">üì∑ –ö–∞–º–µ—Ä–∞</button>
          <button onclick="jitsiApi.executeCommand('toggleChat')">üí¨ –ß–∞—Ç</button>
          <button onclick="jitsiApi.executeCommand('toggleShareScreen')">üñ• –≠–∫—Ä–∞–Ω</button>
          <button onclick="alertParticipants()">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
          <button onclick="toggleWhiteboard()">üìã Whiteboard</button>
        </div>
      </div>
    </section>
  </main>

  <nav class="tab-bar">
    <button id="btn-next" class="active">üî•<br>–°–æ–±—ã—Ç–∏–µ</button>
    <button id="btn-schedule">üìÖ<br>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
    <button id="btn-homework">üìù<br>–î–æ–º–∞—à–∫–∞</button>
    <button id="btn-video">üé•<br>–í–∏–¥–µ–æ</button>
    <button id="btn-jitsi">ü¶ö<br>Jitsi</button>
  </nav>

  <script type="module">
  // ================== TELEGRAM init ===================
  Telegram.WebApp.ready();
  const tgUser = Telegram.WebApp.initDataUnsafe.user || {};
  document.getElementById('student-name').textContent = tgUser.first_name || '–°—Ç—É–¥–µ–Ω—Ç';

  // ================== GOOGLE CALENDAR ===================
  const CLIENT_ID     = '156070127304-l8lqdcetr3rqdln2sfm59a1iu8is421l.apps.googleusercontent.com';
  const API_KEY       = 'AIzaSyALADqAQwTUzs1pLyI_ORMI8SULs5T0HN8';
  const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
  const SCOPES        = 'https://www.googleapis.com/auth/calendar.readonly';

  let events = [], calendar = null;
  const authorizeBtn = document.getElementById('authorize-btn');
  const nextContent  = document.getElementById('next-event-content');
  const calendarEl   = document.getElementById('calendar');
  const eventListEl  = document.getElementById('event-list');

  function handleClientLoad() {
    gapi.load('client:auth2', initClient);
  }
  async function initClient() {
    await gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: [DISCOVERY_DOC],
      scope: SCOPES
    });
    gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
    updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
    authorizeBtn.onclick = () => gapi.auth2.getAuthInstance().signIn();
  }
  function updateSigninStatus(signedIn) {
    if (signedIn) {
      authorizeBtn.style.display = 'none';
      loadEvents();
    } else {
      authorizeBtn.style.display = 'inline-block';
      nextContent.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å';
    }
  }
  async function loadEvents() {
    const resp = await gapi.client.calendar.events.list({
      calendarId: 'primary',
      timeMin: new Date().toISOString(),
      showDeleted: false,
      singleEvents: true,
      orderBy: 'startTime',
      maxResults: 50
    });
    events = resp.result.items.map(ev=>({
      title: ev.summary||'(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)',
      start: ev.start.dateTime||ev.start.date,
      end:   ev.end.dateTime  ||ev.end.date
    }));
    renderNextEvent();
    renderCalendar();
  }
  function renderNextEvent() {
    if(!events.length){
      nextContent.textContent='–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π';
      return;
    }
    const nxt=new Date(events[0].start);
    nextContent.innerHTML=`<strong>${events[0].title}</strong><br>
      ${nxt.toLocaleDateString('ru-RU',{day:'numeric',month:'long'})}
      ${nxt.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}`;
  }
  function renderCalendar(){
    if(calendar) calendar.destroy();
    calendar=new FullCalendar.Calendar(calendarEl,{
      initialView:'dayGridMonth',
      locale:'ru',
      events,
      dateClick:info=>{
        const day=info.dateStr;
        const list=events.filter(e=>e.start.startsWith(day));
        eventListEl.innerHTML=list.length
          ? list.map(e=>`<li>${e.start.slice(11,16)}‚Äì${e.end.slice(11,16)} ${e.title}</li>`).join('')
          : '<li>–ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</li>';
      }
    });
    calendar.render();
  }
  handleClientLoad();

  // ================== SUPABASE STORAGE ===================
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  const supabase = createClient(
    'https://lwmervaxwrllgykcjfpn.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3bWVydmF4d3JsbGd5a2NqZnBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0NDk3NjksImV4cCI6MjA2NjAyNTc2OX0.x8Ri1xtidyNqJDl4QgeSzTP2d0FaHLFPV7vBIIytLp4'
  );

  // –î–æ–º–∞—à–∫–∏
  async function uploadHomework(){
    const f=document.getElementById('hw-file').files[0];
    const st=document.getElementById('hw-status');
    if(!f){ st.textContent='–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'; return; }
    const path=`${tgUser.id}/${Date.now()}_${f.name}`;
    const {error}=await supabase.storage.from('homework').upload(path,f);
    st.textContent= error? '‚ùå '+error.message : '‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ';
    listHomework();
  }
  async function listHomework(){
    const list=document.getElementById('hw-list');
    const {data,error}=await supabase.storage.from('homework').list(tgUser.id+'/');
    if(error||!data){ list.textContent='–û—à–∏–±–∫–∞'; return; }
    list.innerHTML='';
    data.forEach(f=>{
      const url=supabase.storage.from('homework').getPublicUrl(tgUser.id+'/'+f.name).data.publicUrl;
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`<div class="card-title">üìÑ ${f.name}</div>
        <a href="${url}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a>`;
      list.appendChild(card);
    });
  }
  // –í–∏–¥–µ–æ
  async function uploadVideo(){
    const f=document.getElementById('video-file').files[0];
    const t=document.getElementById('video-title').value.trim();
    const st=document.getElementById('video-status');
    if(!f||!t){ st.textContent='–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'; return; }
    const path=`${tgUser.id}/${Date.now()}_${f.name}`;
    let {error}=await supabase.storage.from('videos').upload(path,f);
    if(error){ st.textContent='‚ùå '+error.message; return; }
    const {error:e2}=await supabase.from('videos').insert([{file_path:path,title:t}]);
    st.textContent=e2? '‚ùå '+e2.message : '‚úÖ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ';
    loadVideos();
  }
  async function loadVideos(){
    const list=document.getElementById('video-list');
    const {data,error}=await supabase.from('videos').select('*').order('uploaded_at',{ascending:false});
    if(error||!data){ list.textContent='–û—à–∏–±–∫–∞'; return; }
    list.innerHTML='';
    data.forEach(item=>{
      const url=supabase.storage.from('videos').getPublicUrl(item.file_path).data.publicUrl;
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`<div class="card-title">üé¨ ${item.title}</div>
        <video controls src="${url}" style="width:100%;border-radius:6px"></video>`;
      list.appendChild(card);
    });
  }

  // ================== JITSI EMBED ===================
  let jitsiApi = null;
  document.getElementById('btn-jitsi').onclick = () => {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById('tab-jitsi').classList.add('active');
    if(!jitsiApi){
      jitsiApi = new JitsiMeetExternalAPI('meet.jit.si',{
        roomName: 'MentoriumRoom123',
        parentNode: document.getElementById('jitsi-container'),
        width:'100%', height:300
      });
      jitsiApi.addEventListener('videoConferenceJoined', ()=>console.log('–í–æ—à–ª–∏ –≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü!'));
    }
  };
  function alertParticipants(){
    jitsiApi.getParticipantsInfo().then(p=>alert('–£—á–∞—Å—Ç–Ω–∏–∫–∏:\n'+p.map(x=>x.displayName).join('\n')));
  }
  function toggleWhiteboard(){ jitsiApi.executeCommand('toggleWhiteboard'); }

  // ================== TAB SWITCH ===================
  function openTab(id){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    document.querySelectorAll('nav.tab-bar button').forEach(b=>b.classList.remove('active'));
    document.getElementById('btn-'+id).classList.add('active');
    if(id==='homework') listHomework();
    if(id==='video') loadVideos();
  }
  document.getElementById('btn-next'    ).onclick = ()=>openTab('next');
  document.getElementById('btn-schedule').onclick = ()=>openTab('schedule');
  document.getElementById('btn-homework').onclick = ()=>openTab('homework');
  document.getElementById('btn-video'   ).onclick = ()=>openTab('video');
  </script>
</body>
</html>